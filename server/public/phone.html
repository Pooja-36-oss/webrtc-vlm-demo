<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Phone Sender</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <h2>Phone Camera Streaming</h2>
  <video id="localVideo" autoplay playsinline muted></video>
  <br>
  <button id="startBtn">Start Camera</button>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const localVideo = document.getElementById("localVideo");
    const startBtn = document.getElementById("startBtn");
    const socket = io();
    const pc = new RTCPeerConnection({ iceServers: [{ urls: "stun:stun.l.google.com:19302" }] });
    const pendingCandidates = [];

    pc.onicecandidate = event => {
      if(event.candidate) socket.emit("signal", { candidate: event.candidate });
    };

    startBtn.onclick = async () => {
      startBtn.disabled = true;
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
        localVideo.srcObject = stream;
        stream.getTracks().forEach(track => pc.addTrack(track, stream));

        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        socket.emit("signal", { sdp: offer });
      } catch(e) {
        console.error(e);
        alert("Allow camera access!");
        startBtn.disabled = false;
      }
    };

    socket.on("signal", async data => {
      try {
        if(data.sdp?.type === "answer") {
          await pc.setRemoteDescription(new RTCSessionDescription(data.sdp));
          while(pendingCandidates.length) await pc.addIceCandidate(new RTCIceCandidate(pendingCandidates.shift()));
        } else if(data.candidate) {
          if(!pc.remoteDescription) pendingCandidates.push(data.candidate);
          else await pc.addIceCandidate(new RTCIceCandidate(data.candidate));
        }
      } catch(e) {
        console.error("Phone signaling error:", e);
      }
    });
  </script>
</body>
</html>
